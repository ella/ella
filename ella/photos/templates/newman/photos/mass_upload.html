{% extends "newman/change_form.html" %}
{% load newman_modify cache i18n %}

{% block content %}
{{ media }}

<form {% if has_file_field %}enctype="multipart/form-data" {% endif %}action="." method="post" id="{{ opts.module_name }}_form" class="change-form">{% block form_top %}{% endblock %}
<div>
    <div class="js-textarea-toolbar"></div>
{% if errors %}
    <p class="errornote">
    {% blocktrans count errors|length as counter %}Please correct the error below.{% plural %}Please correct the errors below.{% endblocktrans %}
    </p>
    <ul class="errorlist">{% for error in adminform.form.non_field_errors %}<li>{{ error }}</li>{% endfor %}</ul>
{% endif %}

{% block fieldsets %}
{% for fieldset in adminform %}
  {% include "newman/includes/fieldset.html" %}
{% endfor %}
{% endblock %}


<div class="submit-row">
    <a id="start-upload" class="js-submit icn btn save def default-button-ok" name="_save">{% trans "Upload photos" %}</a>
</div>

</div>

<div class="js-form-metadata">
    <input type="hidden" name="success" id="save-change-form-success" />
    <script type="text/javascript">
        $('#save-change-form-success').data('callback', save_change_form_success);
    </script>
</div>

</form>

{% endblock %}

{% block content_js %}
    <script type="text/javascript">
        $(document).ready(function() {
            /**
             * Adds serializeObject method to elements. When called on forms, it results
             * in form being serialized into JSON object {name:value, name2: value2}.
             */
            // $.fn.serializePostObject = function() {
                // var o = {};
                // var a = this.serializeArray();
                // $.each(a, function() {
                    // if (o[this.name] !== undefined) {
                        // if (!o[this.name].push) {
                            // o[this.name] = [o[this.name]];
                        // }
                        // o[this.name].push(String(this.value) || '');
                    // } else {
                        // o[this.name] = String(this.value) || '';
                    // }
                // });
                // return o;
            // };
            
            var $uploadifyTarget = $('#id_image');
            var originalObjectId = null;
            
            $uploadifyTarget.uploadify({
                'uploader'       : '{{ NEWMAN_MEDIA_URL }}swf/uploadify.swf',
                'script'         : '{% url newman:photo-mass-upload-file %}',
                'scriptAccess'   : 'always',
                'cancelImg'      : '{{ NEWMAN_MEDIA_URL }}img/cancel.png',
                'buttonText'     : '{% trans "Choose images" %}',
                'fileExt'        : '*.png;*.jpg;*.jpeg',
                'fileDesc'       : '{% trans "Image files (*.png, *.jpg, *.jpeg)" %}',
                'fileDataName'   : 'image',
                'multi'          : true,
                'onError'        : function (event, ID, fileObj, errorObj) {
                    $uploadifyTarget.uploadifyClearQueue();
                    console.log(errorObj);
                    console.log(event);
                    show_err('{% trans "Photo upload failed. Check for form errors." %}');
                },
                'onAllComplete': function (event, data) {
                    show_ok('{% trans "All images have been uploaded." %}');
                    adr('{% url newman:photos_photo_changelist %}', {just_set: true, nohistory: true});
                }
            });
            
            function startUpload () {
                var formData = $('form').serializeObject();
                // var ar = $('form').serializePostObject();
                // console.log(ar);
                // formData['id_authors[]'] = formData['authors'];
                // delete formData.authors;
                
                console.log('Appending data to send along with upload:' + JSON.stringify(formData));
                $uploadifyTarget.uploadifySettings('scriptData', formData, true);
                $uploadifyTarget.uploadifyUpload();                
            }
            
            $('#start-upload').unbind('click').click(startUpload);
        });
    </script>
    <script type="text/javascript">
    request_media(MEDIA_URL + 'jquery/jquery-urldecode-encode.js');
    function trigger_changelist_shown() {
        $(document).trigger('changeform_shown'); // bound in inlines.js
    }
    $(document).one('media_loaded', trigger_changelist_shown);
    </script>
{% endblock %}
